import React, { useState, useEffect, useRef } from 'react';

const SECRET = 'D3r5t0n3';

const EXTENSIONS = [
  { name: 'AsuraScans', url: 'https://asuracomic.net', desc: 'Action & fantasy manhwa' },
  { name: 'Ezmanga', url: 'https://ezmanga.org', desc: 'Manga & manhwa reader' },
  { name: 'Comix', url: 'https://comix.to', desc: 'Modern manga platform' },
];

export default function ManhyoReader() {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [password, setPassword] = useState('');
  const [selectedUrl, setSelectedUrl] = useState('');
  const iframeRef = useRef(null);

  const handleLogin = () => {
    if (password === SECRET) {
      setIsLoggedIn(true);
    } else {
      alert('Incorrect password');
    }
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter') handleLogin();
  };

  const openReader = (url) => {
    setSelectedUrl(url);
    setTimeout(() => {
      const overlay = document.getElementById('overlay');
      if (overlay && document.fullscreenEnabled) {
        overlay.requestFullscreen?.();
      }
    }, 50);
  };

  useEffect(() => {
    const handleFullscreenChange = () => {
      if (!document.fullscreenElement) {
        setSelectedUrl('');
      }
    };
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    return () => document.removeEventListener('fullscreenchange', handleFullscreenChange);
  }, []);

  useEffect(() => {
    if (!selectedUrl) return;

    const handleKeyDown = (e) => {
      if (!document.fullscreenElement) return;

      const url = selectedUrl || '';

      if (url.includes('comix.to')) {
        const blockKeys = ['ArrowDown', 'ArrowUp', 'PageDown', 'PageUp', ' '];
        if (blockKeys.includes(e.key)) {
          e.preventDefault();
        }
        return;
      }

      const keys = ['ArrowDown', 'ArrowUp', 'PageDown', 'PageUp'];
      if (!keys.includes(e.key)) return;

      e.preventDefault();

      try {
        iframeRef.current?.contentWindow?.scrollBy({
          top:
            e.key === 'ArrowDown' ? 120 :
            e.key === 'ArrowUp' ? -120 :
            e.key === 'PageDown' ? 450 :
            -450,
          behavior: 'smooth'
        });
      } catch (err) {
        // fallback if cross-origin
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [selectedUrl]);

  return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@600;700&display=swap');

        #manhyo-root * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }

        #manhyo-root {
          min-height: 100vh;
          background: radial-gradient(circle at top, #6d28d9, #050507 70%);
          color: white;
          font-family: "Courier New", monospace;
          position: fixed;
          inset: 0;
          overflow-y: auto;
        }

        .manhyo-login {
          position: fixed;
          inset: 0;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .manhyo-login-box {
          text-align: center;
        }

        .manhyo-title {
          font-family: "Space Grotesk", sans-serif;
          font-size: 4.8rem;
          letter-spacing: 6px;
          margin-bottom: 10px;
          text-shadow: 0 0 40px rgba(139,92,246,.8);
        }

        .manhyo-login-box p {
          opacity: .7;
          margin-bottom: 30px;
        }

        .manhyo-input {
          padding: 12px;
          width: 180px;
          border-radius: 14px;
          border: none;
          background: rgba(255,255,255,.15);
          color: white;
          text-align: center;
        }

        .manhyo-input::placeholder {
          color: rgba(255,255,255,0.6);
        }

        .manhyo-button {
          margin-top: 16px;
          padding: 12px 20px;
          border-radius: 16px;
          border: none;
          cursor: pointer;
          background: linear-gradient(135deg, #8b5cf6, #6d28d9);
          color: white;
          font-weight: 700;
          box-shadow: 0 0 30px rgba(139,92,246,.6);
        }

        .manhyo-app {
          padding: 50px;
        }

        .manhyo-layout {
          display: grid;
          grid-template-columns: 1fr 1.2fr;
          gap: 60px;
          max-width: 1300px;
          margin: auto;
        }

        .manhyo-left h1 {
          font-family: "Space Grotesk", sans-serif;
          font-size: 4rem;
          letter-spacing: 5px;
        }

        .manhyo-left p {
          opacity: .8;
          line-height: 1.7;
          max-width: 480px;
        }

        .manhyo-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap: 22px;
        }

        .manhyo-card {
          background: rgba(255,255,255,.08);
          backdrop-filter: blur(18px);
          border-radius: 22px;
          padding: 22px;
          cursor: pointer;
          transition: .25s;
          box-shadow: 0 25px 50px rgba(0,0,0,.6);
        }

        .manhyo-card:hover {
          transform: translateY(-6px);
          box-shadow: 0 30px 80px rgba(139,92,246,.35);
        }

        .manhyo-card h3 {
          font-family: "Space Grotesk", sans-serif;
          margin-bottom: 6px;
        }

        .manhyo-overlay {
          position: fixed;
          inset: 0;
          background: black;
          z-index: 9999;
        }

        .manhyo-iframe {
          width: 100%;
          height: 100%;
          border: none;
        }
      `}</style>

      <div id="manhyo-root">
        {!isLoggedIn ? (
          <div className="manhyo-login">
            <div className="manhyo-login-box">
              <div className="manhyo-title">MANHYO</div>
              <p>Read manhwa & manga in one clean place.</p>
              <input
                type="password"
                className="manhyo-input"
                placeholder="Password"
                autoComplete="off"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                onKeyDown={handleKeyPress}
              />
              <br />
              <button className="manhyo-button" onClick={handleLogin}>
                Enter
              </button>
            </div>
          </div>
        ) : (
          <div className="manhyo-app">
            <div className="manhyo-layout">
              <div className="manhyo-left">
                <h1>MANHYO</h1>
                <p>
                  Manhyo is a private reader hub that lets you open your favorite
                  sites in fullscreen without distractions.
                </p>
              </div>
              <div className="manhyo-right">
                <div className="manhyo-grid">
                  {EXTENSIONS.map((ext) => (
                    <div
                      key={ext.name}
                      className="manhyo-card"
                      onClick={() => openReader(ext.url)}
                    >
                      <h3>{ext.name}</h3>
                      <p>{ext.desc}</p>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        {selectedUrl && (
          <div id="overlay" className="manhyo-overlay">
            <iframe
              ref={iframeRef}
              className="manhyo-iframe"
              src={selectedUrl}
              allow="fullscreen"
            />
          </div>
        )}
      </div>
    </>
  );
}
